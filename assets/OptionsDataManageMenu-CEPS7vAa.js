import{j as a}from"./jsx-runtime-Cf8x2fCZ.js";import{d as Q}from"./styled-components.browser.esm-CIS6JKSM.js";import{O as W}from"./OptionsDataResetModal-BxqS_KVT.js";import{O as Y}from"./OptionsDataUploadModal-BzlOn__g.js";import{M as B}from"./MenuTitle-C7FRvFNi.js";import{I as h}from"./IconButton-B9x6gfbo.js";import{S as g}from"./SimpleModal-D_HuuXF6.js";import{T as d}from"./Text-5VRYE6Ju.js";import{r as O}from"./index--qcDGAq6.js";import{f as J,g as L,h as q,i as $}from"./defaultValues-BGh_tAG0.js";import{i as p,d as C}from"./typeGuards-Bsa9ERJp.js";import{i as w}from"./checkedAlgorithmIdsValidator-D3rPSOXE.js";import{c as x}from"./quickSlotsValidator-CSlQ7P7m.js";import{i as V,a as b,c as X,s as Z,b as ee}from"./fontNoValidator-DiGyRE7l.js";import{a as F,i as te,b as U,c as oe}from"./hiderOptionsValidator-CGMdHXNl.js";import{i as j,s as se,a as G,b as re}from"./isTierHiddenSanitizer-CaaHuIa3.js";import{V as r,S as o,a as S,b as ne,C as ie}from"./commands-BoKETmK5.js";import{i as ae}from"./gachaOptionsValidator-CX_fe7zV.js";import{i as ce}from"./isShouldShowWelcomeMessageDataValidator-BKshx6sc.js";import{s as k}from"./checkedAlgorithmIdsSanitizer-DLz5h8R0.js";import{s as le,a as Te}from"./quickSlotsSanitizer-Ua222-P8.js";import{f as Oe}from"./formatDate-DtmnLriP.js";import{D as Ee}from"./DataFileUploadButton-D46EKoSS.js";const Se=e=>O.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:32,height:32,viewBox:"0 0 512 512",...e},O.createElement("path",{d:"M272 64h-16c-4.4 0-8 3.6-8 8v72c0 4.4 7.6 8 12 8h12c4.4 0 8-3.6 8-8V72c0-4.4-3.6-8-8-8z",fill:"currentColor"}),O.createElement("path",{d:"M433.9 130.1L382 78.2c-9-9-21.3-14.2-34.1-14.2h-28c-8.8 0-16 7.3-16 16.2v80c0 8.8-7.2 16-16 16H160c-8.8 0-16-7.2-16-16v-80c0-8.8-7.2-16.2-16-16.2H96c-17.6 0-32 14.4-32 32v320c0 17.6 14.4 32 32 32h320c17.6 0 32-14.4 32-32V164c0-12.7-5.1-24.9-14.1-33.9zM322 400.1c0 8.8-8 16-17.8 16H143.8c-9.8 0-17.8-7.2-17.8-16v-96c0-8.8 8-16 17.8-16h160.4c9.8 0 17.8 7.2 17.8 16v96z",fill:"currentColor"})),me=e=>O.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:32,height:32,viewBox:"0 0 24 24",...e},O.createElement("path",{fill:"currentColor",d:"m14 2l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm4 18V9h-5V4H6v16zm-6-1l-4-4h2.5v-3h3v3H16z"})),pe=e=>O.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:32,height:32,viewBox:"0 0 24 24",...e},O.createElement("path",{fill:"currentColor",d:"M13.81 22H6c-1.11 0-2-.89-2-2V4a2 2 0 0 1 2-2h8l6 6v5.09c-.33-.05-.66-.09-1-.09s-.67.04-1 .09V9h-5V4H6v16h7.09c.12.72.37 1.39.72 2m8.73-.88L20.41 19l2.13-2.12l-1.42-1.41L19 17.59l-2.12-2.12l-1.41 1.41L17.59 19l-2.12 2.12l1.41 1.42L19 20.41l2.12 2.13z"})),ue=Q.div`
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  row-gap: 10px;

  width: 270px;
`,y=e=>Array.isArray(e)?Array.isArray(e)&&e.every(t=>H(t)):!1,H=e=>p(e)&&"problemId"in e&&"expiresAt"in e&&typeof e.problemId=="number"&&C(e.expiresAt)&&!isNaN(e.problemId)&&e.problemId%1===0&&e.problemId>=1e3,_e=e=>{if(!Array.isArray(e))return J;const t=Date.now();return e.filter(s=>H(s)&&t<Date.parse(s.expiresAt)).slice(-300)},z=e=>p(e)&&r.DATA_VERSION in e&&r.CHECKED_ALGORITHM_IDS in e&&r.QUICK_SLOTS in e&&r.TOTAMJUNG_THEME in e&&r.HIDER_OPTIONS in e&&r.RANDOM_DEFENSE_HISTORY in e&&r.IS_TIER_HIDDEN in e&&r.FONT_NO in e&&r.TIMERS in e?(e[o.DATA_VERSION]==="v1.2"||e[o.DATA_VERSION]===2)&&w(e[o.CHECKED_ALGORITHM_IDS])&&x(e[o.QUICK_SLOTS])&&V(e[o.TOTAMJUNG_THEME])&&F(e[o.HIDER_OPTIONS])&&j(e[o.RANDOM_DEFENSE_HISTORY])&&typeof e[o.IS_TIER_HIDDEN]=="boolean"&&b(e[o.FONT_NO])&&y(e[o.TIMERS]):!1,K=e=>p(e)&&o.DATA_VERSION in e&&o.CHECKED_ALGORITHM_IDS in e&&o.QUICK_SLOTS in e&&o.TOTAMJUNG_THEME in e&&o.HIDER_OPTIONS in e&&o.RANDOM_DEFENSE_HISTORY in e&&o.IS_TIER_HIDDEN in e&&o.FONT_NO in e&&o.TIMERS in e&&o.GACHA_OPTIONS in e&&o.SHOULD_SHOW_WELCOME_MESSAGE in e?e[o.DATA_VERSION]===3&&w(e[o.CHECKED_ALGORITHM_IDS])&&x(e[o.QUICK_SLOTS])&&V(e[o.TOTAMJUNG_THEME])&&te(e[o.HIDER_OPTIONS])&&j(e[o.RANDOM_DEFENSE_HISTORY])&&typeof e[o.IS_TIER_HIDDEN]=="boolean"&&b(e[o.FONT_NO])&&y(e[o.TIMERS])&&ae(e[o.GACHA_OPTIONS])&&ce(e[o.SHOULD_SHOW_WELCOME_MESSAGE]):!1,fe=e=>e===!0,P=["v1.2",2,3],Ie=e=>F(e)?e:L,De=(e,t)=>{const s=U(e)?{hours:Number(e.hour),minutes:Number(e.minute)}:{hours:0,minutes:20},i=oe(t)?{algorithmHiderUsage:t.predict,problemTagLockUsage:t.lock==="always"?"auto":"click"}:{algorithmHiderUsage:"click",problemTagLockUsage:"click"};return{...L,problemTagLockDuration:s,...i}},Ne=e=>({...e,shouldRevealTierOnHover:!1}),Me=e=>{if(!p(e)||!("theme"in e))return"none";const{theme:t}=e;return t==="yes"?"totamjung":"none"},He=e=>{const{selectedNo:t,...s}=e;return{selectedSlotNo:t,slots:s,hotkey:"Alt"}},Ae=e=>{const t=[];return e.forEach(({no:s,title:i,tier:l,date:c})=>{const T=new Date(c).toISOString();C(T)&&t.push({problemId:s,title:i,tier:l,createdAt:T})}),t},Re=e=>{if(!p(e)||!("font"in e))return 0;const t=e.font;return!X(t)||t==="none"?0:Number(t.split("-")[1])},he=e=>{if(!U(e))return[];const{expire:t,problem:s}=e,i=new Date(t);if(isNaN(i.getTime()))return[];if(s===-1)return[];const l=new Date(t).toISOString(),c={problemId:s,expiresAt:l};return H(c)?[c]:[]},ge=(e,t)=>{const s=Te(e[S.QUICK_SLOTS]),i=re(t[ne.RANDOM_DEFENSE_HISTORY]),l=k(e[S.CHECKED_ALGORITHM_IDS]),c=G(e[o.IS_TIER_HIDDEN]),T=Me(e[S.SETTINGS]),E=De(e[S.TIMER],e[S.SETTINGS]),n=He(s),_=Ae(i),f=Re(e[S.SETTINGS]),A=he(e[S.TIMER]);return{[r.CHECKED_ALGORITHM_IDS]:l,[r.QUICK_SLOTS]:n,[r.TOTAMJUNG_THEME]:T,[r.HIDER_OPTIONS]:E,[r.RANDOM_DEFENSE_HISTORY]:_,[r.IS_TIER_HIDDEN]:c,[r.FONT_NO]:f,[r.TIMERS]:A,[r.SHOULD_SHOW_WELCOME_MESSAGE]:!1,[r.DATA_VERSION]:2}},v=e=>{const t=Ie(e[r.HIDER_OPTIONS]),s=k(e[r.CHECKED_ALGORITHM_IDS]),i=le(e[r.QUICK_SLOTS]),l=Z(e[r.TOTAMJUNG_THEME]),c=Ne(t),T=se(e[r.RANDOM_DEFENSE_HISTORY]),E=G(e[o.IS_TIER_HIDDEN]),n=ee(e[r.FONT_NO]),_=_e(e[r.TIMERS]),f=fe(e[r.SHOULD_SHOW_WELCOME_MESSAGE]);return{[o.CHECKED_ALGORITHM_IDS]:s,[o.QUICK_SLOTS]:i,[o.TOTAMJUNG_THEME]:l,[o.HIDER_OPTIONS]:c,[o.RANDOM_DEFENSE_HISTORY]:T,[o.IS_TIER_HIDDEN]:E,[o.FONT_NO]:n,[o.TIMERS]:_,[o.GACHA_OPTIONS]:q,[o.SHOULD_SHOW_WELCOME_MESSAGE]:f,[o.DATA_VERSION]:3}},de=e=>{const{dataVersion:t}=e;return t===2||t==="v1.2"?2:t===3?3:1},ve=async()=>{const[e,t]=await Promise.all([browser.storage.sync.get(),browser.storage.local.get()]),s=de(t);if(s!==3){if(s===1){browser.storage.local.set(v(ge(e,t)));return}await browser.storage.local.set(v(t))}},Le=async e=>{if(!p(e)||!("dataVersion"in e))return!1;const{dataVersion:t}=e;return typeof t!="number"&&typeof t!="string"||!P.includes(t)||(t==="v1.2"||t===2)&&!z(e)?!1:t!==3?(await browser.storage.local.set(e),await ve(),!0):K(e)?(await browser.storage.local.set(e),!0):!1},Ce=async()=>(await browser.storage.local.set($),!0),we=(e,t)=>{const s=document.createElement("a"),i=new Blob([e],{type:"text/plain"});s.href=URL.createObjectURL(i),s.download=t,s.click(),URL.revokeObjectURL(s.href)},xe=async()=>{const e=await browser.runtime.sendMessage({command:ie.FETCH_OPTIONS_DATA}),t=JSON.stringify(e),s=`totamjung_savefile_${Oe(new Date).replace(" ","_")}.ttj`;we(t,s)},Ve=()=>{const[e,t]=O.useState("none"),[s,i]=O.useState(void 0),[l,c]=O.useState({errorTitle:"",errorMessage:""}),{errorTitle:T,errorMessage:E}=l,n=I=>{c(I),t("error")};return{activeModal:e,errorTitle:T,errorMessage:E,setActiveModal:t,resetOptionsData:async()=>{await Ce()&&(t("none"),location.reload())},extractOptionsData:async()=>{xe(),t("none")},stageOptionsData:async I=>{const R=I.target.files;if(!R)return;const D=R[0];if(D.name.split(".").at(-1)!=="ttj"){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:'세이브파일의 확장자는 ".ttj" 여야 합니다.'});return}if(D.size>1048576){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:"세이브파일의 용량은 1MiB 이하여야 합니다."});return}const N=new FileReader;N.onload=async()=>{try{const M=N.result;if(typeof M!="string"){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:"세이브파일의 형식이 올바르지 않습니다."});return}const u=JSON.parse(M),{dataVersion:m}=u;if(!("dataVersion"in u)||m!=="v1.2"&&typeof m!="number"){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:"데이터의 버전 정보를 알 수 없는 세이브파일입니다. 버그라고 생각하시는 경우 개발자에게 문의를 부탁드립니다."});return}if(!P.includes(m)){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:`이 세이브파일의 버전은 ${m}으로, 이 버전에서 다룰 수 있는 가장 높은 데이터 버전인 3보다 높거나, 이 버전에서 인식할 수 없는 버전입니다.`});return}if(["v1.2",2].includes(m)&&!z(u)){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:"v1.2.* 버전 데이터의 세이브파일은 업로드 가능하나, 이 세이브파일은 데이터의 일부 또는 전부가 손실된 것 같습니다. 버그라고 생각하시는 경우 개발자에게 문의를 부탁드립니다."});return}if(m===3&&!K(u)){n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:"데이터의 일부 또는 전부가 손실된 세이브파일인 것 같습니다. 버그라고 생각하시는 경우 개발자에게 문의를 부탁드립니다."});return}i(u),t("upload")}catch{n({errorTitle:"데이터를 업로드하지 못했습니다",errorMessage:'데이터의 형식이 올바르지 않습니다. 토탐정의 세이브파일이 아닌 파일의 확장자를 ".ttj"로 바꿨을 경우 이 문제가 발생할 수 있습니다. 세이브파일을 다시 검토해 주시겠어요?'})}},N.readAsText(D)},uploadOptionsData:async()=>{s&&(Le(s),location.reload())},closeModal:()=>{t("none")}}},at=()=>{const{activeModal:e,errorTitle:t,errorMessage:s,setActiveModal:i,resetOptionsData:l,extractOptionsData:c,stageOptionsData:T,uploadOptionsData:E,closeModal:n}=Ve();return a.jsxs(ue,{children:[a.jsx(B,{title:"데이터 관리",iconSrc:a.jsx(Se,{})}),a.jsx(h,{type:"button",name:"설정 데이터 내보내기",size:"large",color:"cyan",disabled:!1,ariaLabel:"설정 데이터 내보내기",iconSrc:a.jsx(me,{}),onClick:()=>{i("extract")}}),a.jsx(Ee,{onChange:T}),a.jsx(h,{type:"button",name:"설정 데이터 초기화",size:"large",color:"#ff5050",disabled:!1,ariaLabel:"설정 데이터 초기화",iconSrc:a.jsx(pe,{}),onClick:()=>{i("reset")}}),a.jsx(d,{type:"normal",fontSize:"16px",children:"현재 설정을 백업해 두고 싶으시거나, 다른 기기로 데이터를 옮기고 싶으실 경우 설정 파일에 대한 데이터를 세이브파일 형태로 내보내거나, 업로드할 수 있습니다."}),a.jsxs(d,{type:"normal",fontSize:"16px",children:["토탐정 세이브파일의 확장자는 ",a.jsx("b",{children:".ttj"}),"입니다."]}),a.jsx(g,{title:"데이터 내보내기",actionType:"cancelConfirm",width:"350px",height:"auto",open:e==="extract",message:"현재 설정을 세이브파일로 내보냅니다. 계속하시려면 [확인] 버튼을 눌러 주세요.",onConfirm:c,onClose:n}),a.jsx(Y,{open:e==="upload",onUpload:E,onClose:n}),a.jsx(W,{open:e==="reset",onReset:l,onClose:n}),a.jsx(g,{title:t,actionType:"confirm",width:"350px",height:"auto",open:e==="error",message:s,onClose:n})]})};export{at as O};
